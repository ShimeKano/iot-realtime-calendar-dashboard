<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard AQI Realtime</title>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    select, button {
      padding: 8px 12px;
      font-size: 14px;
    }

    .chart-container {
      width: 90%;
      max-width: 900px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
    }

    .note {
      text-align: center;
      margin-top: 10px;
      font-size: 13px;
      color: #666;
    }
  </style>
</head>

<body>

<h1>üìä AQI Realtime & History Dashboard</h1>

<div class="controls">
  <label>
    üìÖ Ch·ªçn ng√†y:
    <select id="dateSelect"></select>
  </label>

  <button onclick="loadData()">üîÑ T·∫£i d·ªØ li·ªáu</button>
</div>

<div class="chart-container">
  <canvas id="aqiChart"></canvas>
</div>

<div class="note">
  ‚è±Ô∏è D·ªØ li·ªáu t·ª± ƒë·ªông c·∫≠p nh·∫≠t m·ªói 5 ph√∫t
</div>

<script>
  const API_URL = "/api/GetHistory";
  const AUTO_REFRESH_MS = 5 * 60 * 1000;

  let chart;

  // T·∫°o dropdown ng√†y (7 ng√†y g·∫ßn nh·∫•t)
  function initDateDropdown() {
    const select = document.getElementById("dateSelect");
    select.innerHTML = "";

    for (let i = 0; i < 7; i++) {
      const d = new Date();
      d.setDate(d.getDate() - i);

      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");

      const dateStr = `${yyyy}-${mm}-${dd}`;

      const option = document.createElement("option");
      option.value = dateStr;
      option.text = dateStr;

      select.appendChild(option);
    }
  }

  async function loadData() {
    const date = document.getElementById("dateSelect").value;
    let url = API_URL;

    if (date) {
      url += `?date=${date}`;
    }

    const res = await fetch(url);
    const json = await res.json();

    renderChart(json.data || []);
  }

  function renderChart(data) {
    const labels = data.map(d => d.time);
    const values = data.map(d => d.aqi);

    if (chart) {
      chart.destroy();
    }

    const ctx = document.getElementById("aqiChart");

    chart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "AQI",
          data: values,
          borderColor: "rgb(75, 192, 192)",
          tension: 0.3,
          fill: false
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  // Auto refresh
  setInterval(loadData, AUTO_REFRESH_MS);

  // Init
  initDateDropdown();
  loadData();
</script>

</body>
</html>
