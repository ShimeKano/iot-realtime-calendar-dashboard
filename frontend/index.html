<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard AQI Th·ªùi Gian Th·ª±c</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      padding: 20px;
    }

    h1 {
      color: #38bdf8;
    }

    .controls {
      margin-bottom: 20px;
    }

    canvas {
      background: #020617;
      border-radius: 10px;
      padding: 10px;
    }

    button {
      padding: 8px 14px;
      background: #38bdf8;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    input {
      padding: 6px;
    }
  </style>
</head>
<body>

<h1>üìà AQI Big Data Time-Series</h1>

<div class="controls">
  <label>Ch·ªçn ng√†y:</label>
  <input type="date" id="datePicker" />
  <button onclick="loadHistory()">Xem d·ªØ li·ªáu</button>
</div>

<canvas id="aqiChart" height="120"></canvas>

<script>
let chart;

async function fetchRealtimeAndSave() {
  await fetch(`/api/GetRealtimeData?lat=21.0152&lon=105.7999`);
  console.log("Fetched realtime & saved");
}

async function loadHistory() {
  const date = document.getElementById("datePicker").value;
  let url = "/api/GetHistory";
  if (date) url += `?date=${date}`;

  const res = await fetch(url);
  const json = await res.json();

  if (!json.data || json.data.length === 0) {
    alert("Ch∆∞a c√≥ d·ªØ li·ªáu cho ng√†y n√†y");
    return;
  }

  const labels = json.data.map(d => d.time.substring(11, 19));
  const aqi = json.data.map(d => d.aqi);
  const pm25 = json.data.map(d => d.pm25);
  const temp = json.data.map(d => d.temp);

  renderChart(labels, aqi, pm25, temp);
}

function renderChart(labels, aqi, pm25, temp) {
  if (chart) chart.destroy();

  chart = new Chart(document.getElementById("aqiChart"), {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "AQI",
          data: aqi,
          borderColor: "#ef4444",
          tension: 0.3
        },
        {
          label: "PM2.5",
          data: pm25,
          borderColor: "#facc15",
          tension: 0.3
        },
        {
          label: "Nhi·ªát ƒë·ªô (¬∞C)",
          data: temp,
          borderColor: "#22c55e",
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: "#e5e7eb" } }
      },
      scales: {
        x: { ticks: { color: "#e5e7eb" } },
        y: { ticks: { color: "#e5e7eb" } }
      }
    }
  });
}

// üîÅ AUTO FETCH M·ªñI 5 PH√öT
fetchRealtimeAndSave();
setInterval(fetchRealtimeAndSave, 5 * 60 * 1000);
</script>

</body>
</html>
