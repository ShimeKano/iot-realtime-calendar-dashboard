<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>AQI Big Data Time-Series Dashboard</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background: linear-gradient(135deg, #0f172a, #020617);
      color: #e5e7eb;
      font-family: Arial, sans-serif;
      padding: 30px;
    }

    h1 {
      color: #38bdf8;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .controls {
      margin: 20px 0;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    input, button, select {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      font-size: 14px;
    }

    button {
      background: #38bdf8;
      color: #020617;
      font-weight: bold;
      cursor: pointer;
    }

    button:hover {
      background: #0ea5e9;
    }

    .notice {
      margin-top: 10px;
      color: #facc15;
      font-style: italic;
    }

    .chart-box {
      margin-top: 30px;
      background: #020617;
      padding: 20px;
      border-radius: 12px;
    }

    footer {
      margin-top: 20px;
      opacity: 0.6;
      font-size: 13px;
    }
  </style>
</head>

<body>

  <h1>üìà AQI Big Data Time-Series</h1>

  <div class="controls">
    <label>üìÖ Ch·ªçn ng√†y:</label>
    <input type="date" id="datePicker" />

    <label>üìä Ch·ªâ s·ªë:</label>
    <select id="metric">
      <option value="pm25">PM2.5</option>
      <option value="aqi">AQI</option>
      <option value="temp">Nhi·ªát ƒë·ªô (¬∞C)</option>
      <option value="humidity">ƒê·ªô ·∫©m (%)</option>
    </select>

    <button onclick="loadData()">Xem d·ªØ li·ªáu</button>
  </div>

  <div id="notice" class="notice"></div>

  <div class="chart-box">
    <canvas id="chart"></canvas>
  </div>

  <footer>
    ‚è±Ô∏è D·ªØ li·ªáu ƒë∆∞·ª£c t·ª± ƒë·ªông c·∫≠p nh·∫≠t m·ªói 5 ph√∫t & l∆∞u tr·ªØ theo th·ªùi gian (time-series)
  </footer>

  <script>
    const API_HISTORY = "/api/GetHistory";
    let chart;

    // T·∫°o placeholder 24 gi·ªù (khi ch∆∞a c√≥ data)
    function generatePlaceholder() {
      const labels = [];
      const values = [];
      const now = new Date();

      for (let i = 23; i >= 0; i--) {
        const t = new Date(now.getTime() - i * 3600000);
        labels.push(t.getHours().toString().padStart(2, "0") + ":00");
        values.push(null);
      }

      return { labels, values };
    }

    function renderChart(labels, values, label) {
      const ctx = document.getElementById("chart").getContext("2d");

      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label,
            data: values,
            borderColor: "#38bdf8",
            backgroundColor: "rgba(56,189,248,0.2)",
            tension: 0.3,
            spanGaps: true,
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    async function loadData() {
      const date = document.getElementById("datePicker").value;
      const metric = document.getElementById("metric").value;
      const notice = document.getElementById("notice");

      notice.innerText = "‚è≥ ƒêang t·∫£i d·ªØ li·ªáu big data theo th·ªùi gian...";

      let url = API_HISTORY;
      if (date) url += "?date=" + date;

      try {
        const res = await fetch(url);
        const json = await res.json();

        if (!json.data || json.data.length === 0) {
          const p = generatePlaceholder();
          renderChart(p.labels, p.values, metric.toUpperCase());
          notice.innerText =
            "‚ö†Ô∏è Ch∆∞a c√≥ d·ªØ li·ªáu cho ng√†y n√†y. H·ªá th·ªëng ƒëang t·ª± ƒë·ªông t√≠ch l≈©y d·ªØ li·ªáu theo th·ªùi gian.";
          return;
        }

        const labels = json.data.map(d =>
          d.time
            ? d.time.slice(11, 16)
            : "--:--"
        );

        const values = json.data.map(d => d[metric] ?? null);

        renderChart(labels, values, metric.toUpperCase());
        notice.innerText = `‚úÖ ƒê√£ t·∫£i ${json.count} b·∫£n ghi (time-series)`;
      } catch (err) {
        notice.innerText = "‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu";
        console.error(err);
      }
    }

    // Load h√¥m nay + auto refresh m·ªói 5 ph√∫t
    window.onload = () => {
      const today = new Date().toISOString().slice(0, 10);
      document.getElementById("datePicker").value = today;
      loadData();

      setInterval(() => {
        loadData();
      }, 5 * 60 * 1000);
    };
  </script>

</body>
</html>
